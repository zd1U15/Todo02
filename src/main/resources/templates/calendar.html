<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Todoカレンダー</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
	<link rel="stylesheet" th:href="@{/css/style.css}">

	<style>
		/* カレンダーの高さを調整 */
		#calendar {
			max-width: 1100px;
			margin: 40px auto;
		}
	</style>
</head>

<body>

	<div class="container">
		<h1 class="my-4">やるべきカモ！</h1>

		<button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addTaskModal">
			<i class="bi bi-plus-circle"></i> + タスクを簡単追加
		</button>

		<div id='calendar'></div>
	</div>

	<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form th:action="@{/task/new}" method="post" th:object="${newTask}">
					<div class="modal-header">
						<h5 class="modal-title" id="addTaskModalLabel">新規タスク追加</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
					    <div class="mb-3">
					        <label for="title" class="form-label">タイトル *</label>
					        <input type="text" class="form-control" id="title" th:field="*{title}" required>
					    </div>
					    <div class="mb-3">
					        <label for="details" class="form-label">詳細</label>
					        <textarea class="form-control" id="details" th:field="*{details}" rows="3"></textarea>
					    </div>
					    
					    <div class="row">
					        <div class="col-md-6 mb-3">
					            <label for="startDate" class="form-label">開始日</label>
					            <input type="date" class="form-control" id="startDate" th:field="*{startDate}">
					        </div>
					        <div class="col-md-6 mb-3">
					            <label for="dueDate" class="form-label">期日 *</label>
					            <input type="date" class="form-control" id="dueDate" th:field="*{dueDate}" required>
					        </div>
					    </div>
					    <div class="row">
					        <div class="col-md-6 mb-3">
					            <label for="category" class="form-label">カテゴリ</label>
					            <select class="form-select" id="category" th:field="*{category}">
					                <option value="仕事">仕事</option>
					                <option value="個人">個人</option>
					                <option value="学習">学習</option>
					                <option value="その他">その他</option>
					            </select>
					        </div>
					        <div class="col-md-6 mb-3">
					            <label for="priority" class="form-label">優先度</label>
					            <select class="form-select" id="priority" th:field="*{priority}">
					                <option value="高">高</option>
					                <option value="中">中</option>
					                <option value="低">低</option>
					            </select>
					        </div>
					    </div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
						<button type="submit" class="btn btn-primary">登録する</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

	<script th:inline="javascript">
		// HTMLが読み込まれたら実行
		document.addEventListener('DOMContentLoaded', function () {
			// 'calendar' (id="calendar" のdiv) を探す
			var calendarEl = document.getElementById('calendar');

			// FullCalendar を初期化
			var calendar = new FullCalendar.Calendar(calendarEl, {
				// --- 表示設定 ---
				initialView: 'dayGridMonth', // 月表示
				headerToolbar: { // ヘッダーのボタン設定
					left: 'prev,next today',
					center: 'title',
					right: 'dayGridMonth,timeGridWeek,listWeek'
				},
				// Bootstrap 5 のテーマを適用
				themeSystem: 'bootstrap5',
				// 日本語設定
				locale: 'ja',
				buttonText: {
					today: '今日',
					month: '月',
					week: '週',
					list: 'リスト'
				},

				// --- イベント(タスク)データ設定 ---
				// Controllerの @GetMapping("/api/tasks") からJSONを取得
				events: '/api/tasks',

				//イベントのデフォルトを終日設定にする
				eventStartEditable: true,
				defaultAllDay: true,

				// --- イベント(タスク)クリック時の動作 ---
				// (これが「クリックすると詳細画面に飛ぶ」機能)
				eventClick: function (info) {
					// info.event.url には、Serviceで設定した "/task/{id}" が入っている
					if (info.event.url) {
						// 既定の動作(あれば)をキャンセル
						info.jsEvent.preventDefault();
						// 設定されたURLに画面遷移
						window.location.href = info.event.url;
					}
				}
			});

			// カレンダーを描画
			calendar.render();
		});
	</script>

</body>

</html>